<html>
<head>
<script type='text/javascript' src='http://static.firebase.com/demo/firebase.js'></script>
<script type='text/javascript' src='js/mootools-core-1.4.2.js'></script>
<script type='text/javascript' src='js/mootools-more-1.4.0.1.js'></script>

<script type='text/javascript' src='js/mersenne-twister.js'></script>
<script type='text/javascript' src='js/Games.js'></script>
<script type='text/javascript' src='games/ButtonRevenge.js'></script>

<script type='text/javascript'>

(function() {

var braceRef = new Firebase('http://gamma.firebase.com/keemy/brace');

var userId = 0;

var channelName, channelRef, usersRef;
function joinChannel(channel_) {
  if(channel_ === "") {
    document.location.hash = "pimps@sea";
    return;
  }
  channelName = document.location.hash.substring(1);

  // TODO - check for valid chars?
  channelRef = braceRef.child(channelName);
  usersRef = channelRef.child('users');

  var lastUserIdRef = channelRef.child('lastUserId');
  lastUserIdRef.transaction(function(lastUserId) {
    return lastUserId+1;
  }, function(success, snapshot) {
    if(success) {
      userId = snapshot.val();

      var userRef = usersRef.child(userId);
      userRef.set({ id: userId, name: "Player " + userId });
      presenceRef = userRef.child('online');
      presenceRef.setOnDisconnect(false);
      presenceRef.set(true);
    }
  });

  // TODO - store the game somewhere?
  var gameClass = devin.games[0];
  game = new gameClass(requestMove);

  var lastGameIdRef = channelRef.child('lastGameId');
  var gamesRef = channelRef.child('games');
  lastGameIdRef.on('value', function(lastGameId) {
    lastGameId = lastGameId.val() || 0;
    gameRef = gamesRef.child(lastGameId);

    var movesRef = gameRef.child('moves');
    movesRef.on('child_added', function(snapshot) {
      //TODO check if game is finished
    });

    var seed = channelName + lastGameId;
    var rand = new MersenneTwister(seed);
    game.initialize(rand);
  });
}

function urlChanged() {
  joinChannel(document.location.hash.substring(1));
}

function requestMove(move) {
}


window.addEvent('load', function() {
  window.addEventListener("hashchange", urlChanged, false);
  urlChanged();
});
})();

</script>
</head>
<body>
</body>
</html>
